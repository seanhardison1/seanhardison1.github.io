<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer">
  

  <link rel="icon" type="image/png" href="../../favicon.png">

  <title>
    
    
     Lower Trophic Levels 
    
  </title>
  <link rel="canonical" href="../../post/lower-trophic-levels/">

  <link rel="stylesheet" href="../../css/fonts.css" />
  <link rel="stylesheet" href="../../css/style.css" />

  
</head>

<body>
<section id=nav>
  <h1><a href="../../">State of the Ecosystem 2018-2019</a></h1>
  <ul>
    
    <li><a href="https://seanhardison1.github.io">Home</a></li>
    
    <li><a href="https://github.com/noaa-edab">GitHub</a></li>
    
  </ul>
</section>


<section id=content>
  <h1> Lower Trophic Levels </h1>

  <div id=sub-header>
    Ecosystems Dynamics and Assessment · 2018/11/26 · 7 minute read
  </div>

  <div class="entry-content">
    
<script src="../../rmarkdown-libs/kePrint/kePrint.js"></script>

<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a><ul>
<li><a href="#ecomon-zooplankton-data-oi">EcoMon zooplankton data (OI)</a></li>
<li><a href="#ecomon-nutrient-data">EcoMon nutrient data</a></li>
</ul></li>
</ul>
</div>

<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>The purpose of this report is to document State of the Ecosystem (SOE) <strong>lower trophic level</strong> indicator data processing. All R code used to process and visualize the following data sets is self-contained in the <a href="https://github.com/NOAA-EDAB/soe/blob/master/inst/Rmd/process_raw.Rmd">Rmarkdown document</a> associated with this HTML file. To run and update data sets in this document, set the <code>save_clean</code> parameter in the set-up chunk to <code>TRUE</code>. Raw data for these indicators are available in the file directory <code>soe/inst/extdata</code>.</p>
<style type="text/css">
pre code, pre, code {
  white-space: pre !important;
  overflow-y: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
  max-height: 400px;
}
</style>
<div id="ecomon-zooplankton-data-oi" class="section level3 tabset tabset-fade">
<h3>EcoMon zooplankton data (OI)</h3>
<p>These data show estimated zooplankton abundances on the NE Shelf derived from Ecosystem Monitoring Program (EcoMon) sampling. EcoMon conducts shelf-wide bimonthly surveys of the Northeast Large Marine Ecosystem, collecting zooplankton and ichthyoplankton to a depth of 200 m using paired Bongo samplers with 333 <span class="math inline">\(\mu\)</span>m mesh netting. Zooplankton abundance data were interpolated across sampling locations using ordinary kriging to create a complete field. Here we present abundance time series for three species: <em>Centropages typicus</em>, <em>Temora longicornis</em>, and <em>Pseudocalanus</em> spp. These data are processed in a similar manner to optimally interpolated ocean temperature and salinity data sets. More information about the source data and processing methods used to derive these data sets can be found <a href="https://noaa-edab.github.io/ECSA/#sec:methodszoo">here</a>.</p>

<div class="tab">
  <button class="tablinks" onclick="opentab(event, 'mid-atlantic-bight')" id="defaultOpen">Mid-Atlantic Bight</button>
  <button class="tablinks" onclick="opentab(event, 'georges-bank')">Georges Bank</button>
  <button class="tablinks" onclick="opentab(event, 'gulf-of-maine')">Gulf of Maine</button>
  <button class="tablinks" onclick="opentab(event, 'processing')">Processing</button>
</div>

<div id="processing" class="tabcontent" style="display:none">
<p><em>Function definitions &amp; spatial processing</em></p>
<pre class="r"><code>#Read in EPU shapefile (will be downsampled to match raster resolution)
epu &lt;- readOGR(file.path(gis.dir, &quot;EPU_Extended.shp&quot;), verbose = F) 

#Write function to build EPU rasters
build_raster &lt;- function(EPU){
  
  #Filter raster by EPU
  epu &lt;- epu[epu$EPU == EPU,]
  
  #Build empty raster
  r1 &lt;- raster::raster()
  e &lt;- raster::extent(-75.950, -65.450, 35.650, 44.650)
  raster::extent(r1) &lt;- e
  
  #fill with EPU polygon
  r1 &lt;- raster::rasterize(epu, r1, field = 1, fun = mean)
  raster::crs(r1) &lt;- NA
  
  #create raster to resample with
  r2 &lt;- raster::raster(nrow = 90, ncol = 105)
  raster::extent(r2) &lt;- e
  raster::crs(r2) &lt;- NA
  
  #Downsample high res EPU raster to match data
  r.new &lt;- raster::resample(r1, r2, method=&quot;bilinear&quot;)
  r.new[is.finite(r.new)] &lt;- 1 
  
  return(r.new)
  
}

#Raster data
mab_rast &lt;- build_raster(&quot;MAB&quot;)
gb_rast &lt;- build_raster(&quot;GB&quot;)
gom_rast &lt;- build_raster(&quot;GOM&quot;)

#Process ECSA data by EPU and create time series

epu_env &lt;- function(variable, type = NULL, season, genus = NULL, epu){
  

  if(!is.null(type) &amp; !variable %in% c(&quot;salinity&quot;,&quot;temperature&quot;)){
    stop(&#39;type only applicable for variables &quot;salinity&quot; and &quot;temperature&quot;
         as type = &quot;bottom&quot; or type = &quot;surface&quot;&#39;)
  } 
  
  if(!is.null(genus) &amp; variable != &quot;zooplankton&quot;){
    stop(&#39;genus only applicable for variable &quot;zooplankton&quot;&#39;)
  } 
  
  #get compiled down-sampled raster of chosen strata from shapefile. 
  epumask.raster &lt;- get(paste0(tolower(epu),&quot;_rast&quot;))
  
  #get bottom temp data and find mean for stock area--------------------------------------
  
  indir &lt;- here(&quot;static&quot;,&quot;inst&quot;,&quot;extdata&quot;,&quot;gridded&quot;)
  
  if (variable == &quot;salinity&quot;){
    load(file.path(indir, paste0(&quot;sal_&quot;,type,&quot;_&quot;,season,&quot;_spdf.rdata&quot;)))
  } else if (variable == &quot;temperature&quot;){
    load(file.path(indir, paste0(&quot;temp_&quot;,type,&quot;_&quot;,season,&quot;_spdf.rdata&quot;)))
  } else if (variable == &quot;chlorophyll&quot;){
    load(file.path(indir, paste0(&quot;chl_&quot;,season,&quot;_1997-2018.rdata&quot;)))
  } else if (variable == &quot;zooplankton&quot;){
    load(file.path(indir, paste0(genus,&quot;_&quot;,season,&quot;_zoo_1977-2016.rdata&quot;)))
  }
  

    #create null df to fill with results
    data = data.frame(array(NA,dim= c(raster::nlayers(ecsa_dat),5)))
    
    #loops through layers in raster brick
    for(i in 1:raster::nlayers(ecsa_dat)){
      #load raster by year
      
      #get file information from title
      layer_id &lt;- stringr::str_extract(names(ecsa_dat)[[i]], &quot;\\d.*&quot;)
      layer_id &lt;- stringr::str_split(layer_id, &quot;_&quot;)
      data[i,1] &lt;- layer_id[[1]][[1]]
      data[i,2] &lt;- layer_id[[1]][[2]]
      data[i,3] &lt;- layer_id[[1]][[3]]
      
      #trim to stock area
      masked.raster = ecsa_dat[[i]]*epumask.raster
      
      #find mean BT of stock area
      data[i,4] = raster::cellStats(masked.raster, stat=&#39;mean&#39;, na.rm=TRUE)
      data[i,5] = raster::cellStats(masked.raster, stat = &#39;sd&#39;, na.rm=TRUE)
      # 
      # if (layer_id[[1]][[1]] == &quot;1995&quot;){
      #   break
      # }
    }
    x &lt;- as.numeric(data$X1)
    y.out &lt;- data$X4
    y.sd &lt;- data$X5
    
    sd.low &lt;- y.out - y.sd
    sd.high &lt;- y.out + y.sd
    
  # remove 
  if (variable == &quot;zooplankton&quot;){
    if (season == &quot;spring&quot;){
      y.out[x %in% c(1989, 1990, 1991, 1994)] &lt;- NA
      sd.low[x %in% c(1989, 1990, 1991, 1994)] &lt;- NA
      sd.high[x %in% c(1989, 1990, 1991, 1994)] &lt;- NA
    } else if (season == &quot;fall&quot;) {
      y.out[x %in% c(1989, 1990, 1992)] &lt;- NA
      sd.low[x %in% c(1989, 1990, 1992)] &lt;- NA
      sd.high[x %in% c(1989, 1990, 1992)] &lt;- NA
    }
  }
  
  if(variable == &quot;chlorophyll&quot;){
    type &lt;- &quot;&quot;
  } else if (variable == &quot;zooplankton&quot;){
    type &lt;- genus
    variable &lt;- &quot;zoo&quot;
  } 
  
  out &lt;- data.frame(Var = paste(paste(type,variable),season),
                    Time = as.numeric(x),
                    Value = y.out,
                    sd.low = sd.low,
                    sd.high = sd.high,
                    Season = season,
                    epu = epu)
  
  out &lt;- out[out$Time &gt; 1968,]
  return(out)
  
}</code></pre>
<p><em>Data pull &amp; aggregation</em></p>
<pre class="r"><code>#MAB---------------------------------------------------------------------------------------------------
ctyp_fall_mab &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;centropages&quot;, season = &quot;fall&quot;, epu = &quot;MAB&quot;)
ctyp_spring_mab &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;centropages&quot;, season = &quot;spring&quot;, epu = &quot;MAB&quot;)

tlong_fall_mab &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;temora&quot;, season = &quot;fall&quot;, epu = &quot;MAB&quot;)
tlong_spring_mab &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;temora&quot;, season = &quot;spring&quot;, epu = &quot;MAB&quot;)

pseudo_fall_mab &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;pseudocalanus&quot;, season = &quot;fall&quot;, epu = &quot;MAB&quot;)
pseudo_spring_mab &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;pseudocalanus&quot;, season = &quot;spring&quot;, epu = &quot;MAB&quot;)


#GB---------------------------------------------------------------------------------------------------
ctyp_fall_gb &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;centropages&quot;, season = &quot;fall&quot;, epu = &quot;GB&quot;)
ctyp_spring_gb &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;centropages&quot;, season = &quot;spring&quot;, epu = &quot;GB&quot;)

tlong_fall_gb &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;temora&quot;, season = &quot;fall&quot;, epu = &quot;GB&quot;)
tlong_spring_gb &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;temora&quot;, season = &quot;spring&quot;, epu = &quot;GB&quot;)

pseudo_fall_gb &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;pseudocalanus&quot;, season = &quot;fall&quot;, epu = &quot;GB&quot;)
pseudo_spring_gb &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;pseudocalanus&quot;, season = &quot;spring&quot;, epu = &quot;GB&quot;)


#GOM---------------------------------------------------------------------------------------------------
ctyp_fall_gom &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;centropages&quot;, season = &quot;fall&quot;, epu = &quot;GOM&quot;)
ctyp_spring_gom &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;centropages&quot;, season = &quot;spring&quot;, epu = &quot;GOM&quot;)

tlong_fall_gom &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;temora&quot;, season = &quot;fall&quot;, epu = &quot;GOM&quot;)
tlong_spring_gom &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;temora&quot;, season = &quot;spring&quot;, epu = &quot;GOM&quot;)

pseudo_fall_gom &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;pseudocalanus&quot;, season = &quot;fall&quot;, epu = &quot;GOM&quot;)
pseudo_spring_gom &lt;- epu_env(variable = &quot;zooplankton&quot;, genus = &quot;pseudocalanus&quot;, season = &quot;spring&quot;, epu = &quot;GOM&quot;)</code></pre>
</div>

<div id="mid-atlantic-bight" class="tabcontent" style="display:block">
<p><img src="../../post/2018-11-26-lower-trophic-levels_files/figure-html/mab_zoo_vis-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>

<div id="georges-bank" class="tabcontent" style="display:none">
<p><img src="../../post/2018-11-26-lower-trophic-levels_files/figure-html/gb_zoo_vis-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>

<div id="gulf-of-maine" class="tabcontent" style="display:none">
<p><img src="../../post/2018-11-26-lower-trophic-levels_files/figure-html/gom_zoo_vis-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>

<script>
// JS to open tabs
function opentab(evt, tab) {
    // Declare all variables
    var i, tabcontent, tablinks;

    // Get all elements with class="tabcontent" and hide them
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }

    // Get all elements with class="tablinks" and remove the class "active"
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Show the current tab, and add an "active" class to the button that opened the tab
    document.getElementById(tab).style.display = "block";
    evt.currentTarget.className += " active";
}
</script>


</div>





<div id="ecomon-nutrient-data" class="section level3 tabset tabset-fade">
<h3>EcoMon nutrient data</h3>
These data include nutrient concentrations, temperature, salinity, density, and dissolved oxygen data sampled via CTD profiles on Ecosystem Monitoring (EcoMon) cruises between 11/3/2009 - 10/19/2016. More metadata are available <a href="https://www.nodc.noaa.gov/oads/data/0127524.xml">here</a>.<br />
</br>
<div align="center">
<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:400px; ">
<table class="table table-striped" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-3">Table 1: </span>Variables in “EcoMon Nutrient Data Through June 2018.csv”
</caption>
<thead>
<tr>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:left;">
Names
</th>
<th style="text-align:left;">
Units
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Cruise identifier
</td>
<td style="text-align:left;width: 5cm; ">
EXPOCODE
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
Cruise identifier
</td>
<td style="text-align:left;width: 5cm; ">
Cruise_ID
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
Station number
</td>
<td style="text-align:left;width: 5cm; ">
STNNBR
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
CTD cast number
</td>
<td style="text-align:left;width: 5cm; ">
CASTNO
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
Sample bottle number
</td>
<td style="text-align:left;width: 5cm; ">
BTLNBR
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
Sample date
</td>
<td style="text-align:left;width: 5cm; ">
Date_UTC
</td>
<td style="text-align:left;">
MM/DD/YYYY
</td>
</tr>
<tr>
<td style="text-align:left;">
Sample time
</td>
<td style="text-align:left;width: 5cm; ">
Time_UTC
</td>
<td style="text-align:left;">
hh:mm
</td>
</tr>
<tr>
<td style="text-align:left;">
Latitude
</td>
<td style="text-align:left;width: 5cm; ">
Latitude
</td>
<td style="text-align:left;">
decimal degrees
</td>
</tr>
<tr>
<td style="text-align:left;">
Longitude
</td>
<td style="text-align:left;width: 5cm; ">
Longitude
</td>
<td style="text-align:left;">
decimal degrees
</td>
</tr>
<tr>
<td style="text-align:left;">
Depth of station
</td>
<td style="text-align:left;width: 5cm; ">
Depth_station
</td>
<td style="text-align:left;">
m
</td>
</tr>
<tr>
<td style="text-align:left;">
Depth of sample
</td>
<td style="text-align:left;width: 5cm; ">
Depth_sampling
</td>
<td style="text-align:left;">
m
</td>
</tr>
<tr>
<td style="text-align:left;">
Water pressure
</td>
<td style="text-align:left;width: 5cm; ">
CTDPRS
</td>
<td style="text-align:left;">
decibars
</td>
</tr>
<tr>
<td style="text-align:left;">
Water temperature
</td>
<td style="text-align:left;width: 5cm; ">
CTDTEMP
</td>
<td style="text-align:left;">
°C
</td>
</tr>
<tr>
<td style="text-align:left;">
Water salinity
</td>
<td style="text-align:left;width: 5cm; ">
CTDSAL
</td>
<td style="text-align:left;">
PSS-78
</td>
</tr>
<tr>
<td style="text-align:left;">
Potential density at surface pressure
</td>
<td style="text-align:left;width: 5cm; ">
Sigma.Theta
</td>
<td style="text-align:left;">
kg m<sup>-3</sup>
</td>
</tr>
<tr>
<td style="text-align:left;">
Dissolved oxygen
</td>
<td style="text-align:left;width: 5cm; ">
CTDOXY
</td>
<td style="text-align:left;">
mg L<sup>-1</sup>
</td>
</tr>
<tr>
<td style="text-align:left;">
Silicic acid concentration
</td>
<td style="text-align:left;width: 5cm; ">
SILCAT
</td>
<td style="text-align:left;">
<span class="math inline">\(\mu\)</span>M
</td>
</tr>
<tr>
<td style="text-align:left;">
Total nitrate and nitrite concentration
</td>
<td style="text-align:left;width: 5cm; ">
NITRIT+NITRAT
</td>
<td style="text-align:left;">
<span class="math inline">\(\mu\)</span>M
</td>
</tr>
<tr>
<td style="text-align:left;">
Ammonia concentration
</td>
<td style="text-align:left;width: 5cm; ">
AMMMONIA
</td>
<td style="text-align:left;">
<span class="math inline">\(\mu\)</span>M
</td>
</tr>
<tr>
<td style="text-align:left;">
Phosphate concentration
</td>
<td style="text-align:left;width: 5cm; ">
PHSPHT
</td>
<td style="text-align:left;">
<span class="math inline">\(\mu\)</span>M
</td>
</tr>
<tr>
<td style="text-align:left;">
Dissolved oxygen
</td>
<td style="text-align:left;width: 5cm; ">
CTDOXYMOL
</td>
<td style="text-align:left;">
<span class="math inline">\(\mu\)</span>mol kg<sup>-1</sup>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p></br>
<strong>Filename</strong>: EcoMon Nutrient Data Through June 2018.csv<br />
<strong>Contributor</strong>: Chris Melrose (<a href="mailto:chris.melrose@noaa.gov" class="email">chris.melrose@noaa.gov</a>)</p>

<div class="tab">
  <button class="tablinks" onclick="opentab(event, 'surface-nutrients')" id="defaultOpen">Surface Nutrients</button>
  <button class="tablinks" onclick="opentab(event, 'bottom-nutrients')">Bottom Nutrients</button>
  <button class="tablinks" onclick="opentab(event, 'qa')">QA</button>
  <button class="tablinks" onclick="opentab(event, 'processing-1')">Processing</button>
</div>


<div id="processing-1" class="tabcontent" style="display:none">

<pre class="r"><code>d &lt;- read.csv(file.path(raw.dir,&quot;EcoMon Nutrient Data Through June 2018.csv&quot;), stringsAsFactors = FALSE)

#Create data frame for mapping units to variable names
mapping &lt;- data.frame(Units = as.character(d[1,]),
                      Var = as.character(names(d)))
mapping[mapping$Units == &quot;&quot; | mapping$Units == &quot;NA&quot;,]$Units &lt;- NA

#remove row with units
d &lt;- slice(d,-1)

d1 &lt;- d %&gt;% 
  mutate(Time = Date_UTC) %&gt;% #create Time variable
  dplyr::select(-Date_UTC,-Time_UTC) %&gt;% #remove time, date
  gather(., Var, Value, -Latitude, -Longitude, -Time, -Depth_sampling, -Depth_station) %&gt;% #turn wide to long while retaining lat/lon
  filter(!is.na(Value)) %&gt;% #remove NA
  left_join(., mapping, by = c(&quot;Var&quot;)) %&gt;% #join units 
  mutate(Longitude = as.numeric(Longitude),
         Latitude = as.numeric(Latitude),
         Time = mdy(Time)) %&gt;% 
  filter(Latitude &gt; 32, Latitude&lt;50)


#Sanity check
# t1 &lt;- d1[d1$Var == &quot;CTDOXYMOL&quot; ,]$Value
# t &lt;-  d %&gt;% slice(.,-1)
# t &lt;- as.character(t$CTDOXYMOL)
# all(t == t1)

#Read in EPU shapefile
epu &lt;- readOGR(file.path(gis.dir, &quot;EPU_Extended.shp&quot;), verbose = F) 
epu &lt;- as(epu, &quot;sf&quot;) #convert to sf object

if(spatial_processing){

  #Test maps
  #All EPUs
  #ggplot() + geom_sf(data = epu)
  
  #Scotian shelf
  # ss &lt;- epu %&gt;% filter(EPU == &quot;SS&quot;)
  # ggplot() + geom_sf(data = ss)
  
  #get latitude and longitude for creating SpatialPointsDataFrame
  lat &lt;-  as.numeric(d$Latitude)
  lon &lt;- as.numeric(d$Longitude)
  coords &lt;- data.frame(lon = lon,lat = lat)
  
  #create spdf
  spdf &lt;- SpatialPointsDataFrame(coords = coords, data = coords,
                                 proj4string = CRS(crs))
  #convert to sf
  coords_sf &lt;- st_as_sf(spdf) 
  
  #get intersection for mapping EPUs back to nutrient data
  epu_intersect &lt;- st_intersection(epu, coords_sf)
  #plot(epu_intersect[epu_intersect$EPU == &quot;MAB&quot;,])
  
  #Map back to nutrient data frame
  epu_df &lt;- data.frame(Longitude = epu_intersect$lon,
                       Latitude = epu_intersect$lat,
                       EPU = epu_intersect$EPU)
  #join
  NE_LME_nutrients &lt;- d1 %&gt;% 
    left_join(.,epu_df, by = c(&quot;Latitude&quot;,&quot;Longitude&quot;))
  
  #Select data for plotting 
  Nitr &lt;- NE_LME_nutrients %&gt;% filter(Var == &quot;NITRIT.NITRAT&quot;)
  
  #Back to SOE format and specify bottom, mid-water, or surface sampling
  NE_LME_nutrients &lt;- NE_LME_nutrients %&gt;%
    dplyr::select(-Latitude, -Longitude) %&gt;% 
    mutate(Value = as.numeric(Value),
           Depth_station = as.numeric(Depth_station),
           Depth_sampling = as.numeric(Depth_sampling)) %&gt;% 
    mutate(bot_dif = Depth_station-Depth_sampling) %&gt;% 
    mutate(surf_bot = ifelse(bot_dif &lt;= 10, &quot;bottom&quot;,
                           ifelse(bot_dif &gt; 10 &amp; Depth_sampling &lt;= 5, &quot;surface&quot;, &quot;mid-water&quot;))) %&gt;% 
    filter(Value &gt; 0, !is.na(EPU), !Var %in% c(&quot;BTLNBR&quot;,&quot;CASTNO&quot;,&quot;Depth_sampling&quot;,
                                             &quot;Depth_station&quot;,&quot;STNNBR&quot;)) %&gt;% 
    mutate(Var = paste(Var, surf_bot)) %&gt;% 
    dplyr::select(Time, Var, Value, Units, EPU) %&gt;% 
    group_by(EPU, Time = year(Time), Var, Units) %&gt;% 
    dplyr::summarise(Value = mean(Value, na.rm = TRUE)) %&gt;% 
    as.data.frame()
  
  if (save_clean){
    save(NE_LME_nutrients,file = file.path(clean.dir, &quot;EcoMon_nutrients.Rdata&quot;))
  }
} else {
  load(file.path(sample.dir,&quot;sample_nutrients.Rdata&quot;))
  load(file.path(clean.dir,&quot;EcoMon_nutrients.Rdata&quot;))
}</code></pre>
</div>
<div id="qa" class="tabcontent" style="display:none">

<p><img src="../../post/2018-11-26-lower-trophic-levels_files/figure-html/ecomon_plotting1-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="surface-nutrients" class="tabcontent" style="display:block">

<p><img src="../../post/2018-11-26-lower-trophic-levels_files/figure-html/surface_nutrients-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="bottom-nutrients" class="tabcontent" style="display:none">

<p><img src="../../post/2018-11-26-lower-trophic-levels_files/figure-html/bottom_nutrients-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>


</div>
</div>

  </div>

  <div id=links>
    
    
      <a class="basic-alignment left" href="../../post/environmental/">Environmental &raquo;</a>
    
  </div>
</section>

<section id="comments">
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
      
      
      if (window.location.hostname == "localhost")
                return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = '';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


  
  
<script src="../../js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>



</body>
</html>

